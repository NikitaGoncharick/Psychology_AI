<style>
    /* Добавьте в ваш CSS файл */
    /* Стилизация скроллбара для боковой панели */
    .sidebar::-webkit-scrollbar {
        width: 6px;
    }

    .sidebar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .sidebar::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }

    .sidebar::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

        /* Стили для чатов в боковой панели */
        /* Форма чата */
    .chat-list form {
        display: block;
        margin-bottom: 5px;
    }

    /* Кнопка в виде чата */
    .chat-item {
        border-radius: 8px;
        padding: 10px 12px;
        border: 1px solid transparent;
        background: transparent;
        text-align: left;
        width: 100%;
        cursor: pointer;
        transition: all 0.2s ease;
        display: block;
    }

    .chat-item:hover {
        background-color: rgba(0, 123, 255, 0.08);
        border-color: rgba(0, 123, 255, 0.2);
    }

    .chat-item.active {
        background-color: rgba(0, 123, 255, 0.1);
        border-left: 3px solid #007bff;
        font-weight: 500;
    }

    /* Убираем стандартные стили кнопки */
    .chat-item:focus {
        outline: none;
        box-shadow: none;
    }

    .chat-time {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 2px;
    }

    /* Стиль для заголовка "All Chats" */
    .chats-header {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }

    /* Кнопка нового чата */
    .btn-new-chat {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        width: 100%;
        font-weight: 500;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }

    .btn-new-chat:hover {
        background-color: #0056b3;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
    }
</style>

<div class="chat-wrapper">
    <!-- Левая боковая панель -->
    <div class="sidebar">
        <div>
            <div class="text-center mb-4">
                <div class="logo-circle">#</div>
                <h5 class="mt-3">All Chats</h5>
            </div>

            <!-- Кнопка нового чата -->
            <form action="/conversations/new" method="post">
                <button type="submit" class="btn-new-chat">+ New Chat</button>
            </form>

            <!-- Список чатов -->
            <div class="chat-list">
                {% if conversations %}
                    {% for conv in conversations %}
                    <form action="/conversations/swith-chat" method="POST" class="d-block mb-1">
                        <input type="hidden" name="chat_id" value="{{ conv.id }}">
                        <button type="submit"
                                class="chat-item w-100 {% if conv.id == active_conversation_id %}active{% endif %}"
                                data-chat-id="{{ conv.id }}"
                                title="{{ conv.title }}">
                            <div class="chat-title">
                                {{ conv.title }}
                            </div>
                            <div class="chat-time">
                                {{ conv.updated_at.strftime('%H:%M') if conv.updated_at else 'Новый' }}
                            </div>
                        </button>
                    </form>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4 text-muted">
                        <small>No chats yet. Start a new conversation!</small>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Простая статистика -->
        <div class="mt-3 pt-3 border-top">
            <small class="text-muted">
                {% if conversations %}
                    Total: {{ conversations|length }} chat{{ 's' if conversations|length != 1 else '' }}
                {% else %}
                    No chats
                {% endif %}
            </small>
        </div>
    </div>

    <!-- чат -->
    <div class="chat-main d-flex flex-column">

      <div class="border-bottom px-4 py-1 bg-white">
        <h5 class="mb-1 fw-bold text-dark">Psychology AI</h5>
        <small class="text-muted">A calm space to talk, whenever you need</small>
        <!--<span class="badge bg-success-subtle text-success-emphasis float-end mt-2">Gentle mode</span> -->
      </div>

        <!--Jinja рендерит всю историю из БД один раз-->
        <!--Jinja проходит по каждому сообщению из списка messages -->
      <div id="messages" class="flex-grow-1 overflow-auto px-4 py-4">
          {% for msg in messages %}
            {% set role = msg.role %}
            {% set content = msg.content %}
            <!--Отправляем собранный пакет данных на рендер в message_block  -->
            {% include "partials/message_block.html" %}
          {% endfor %}
      </div>

      <div id="typing" class="htmx-indicator px-4 pb-1">
        <div class="msg-ai d-inline-block p-1"><i>печатает...</i></div>
      </div>

      <div class="chat-footer">
        <!--обработчик, который передаёт текст в Python-функцию-->
        <!--hx-post просто перехватывает обычную отправку формы и делает её через AJAX вместо перезагрузки страницы-->
        <!--hx-swap="beforeend" Отвечает за то, что бы кажддое новое сообщение было вставлено в конец переписки-->
        <form
                hx-post="/send"
                hx-target="#messages"
                hx-swap="beforeend"
                hx-indicator="#typing">

          <div class="input-group">
            <input name="text" class="form-control shadow-sm input-message" placeholder="Share what's on your mind..." autofocus required>
            <button type="submit" class="btn btn-send"> > </button>
          </div>
        </form>

        <div class="text-center mt-3">
          <small class="text-muted">
            This space is for reflection and support. It is not a substitute for emergency or crisis services.
          </small>
        </div>
      </div>
    </div>
    <!-- конец чата -->

  </div>
  <!-- конец монолитного блока -->