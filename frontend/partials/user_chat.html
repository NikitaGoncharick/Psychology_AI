<style>
    /* Скроллбары */
    ::-webkit-scrollbar {
        width: 6px;
    }
    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* Боковая панель */
    .sidebar {
        overflow-y: hidden;
        display: flex;
        flex-direction: column;
    }
    .chat-list-container {
        max-height: calc(100vh - 280px);
        overflow-y: auto;
        padding-right: 5px;
        margin-bottom: 15px;
        flex: 1;
        scrollbar-width: thin;
        scrollbar-color: #888 #f1f1f1;
    }

    /* Формы чатов в списке */
    .chat-list form {
        position: relative;
        display: block;
        margin-bottom: 5px;
    }

    /* Элемент чата */
    .chat-item {
        border-radius: 8px;
        padding: 10px 12px;
        border: 1px solid transparent;
        background: transparent;
        text-align: left;
        width: 100%;
        cursor: pointer;
        transition: all 0.05s ease;
        display: block;
    }
    .chat-item:hover {
        background-color: rgba(0, 123, 255, 0.08);
        border-color: rgba(0, 123, 255, 0.2);
    }
    .chat-item.active {
        background-color: rgba(0, 123, 255, 0.1);
        border-left: 3px solid #007bff;
        font-weight: 500;
    }
    .chat-item:focus {
        outline: none;
        box-shadow: none;
    }

    /* Название чата */
    .chat-title {
        flex: 1;
        min-width: 0;
    }

    /* Плейсхолдер под троеточие */
    .chat-menu-placeholder {
        width: 32px;
        flex-shrink: 0;
    }

    /* Кнопка троеточия */
    .chat-menu-btn {
        position: absolute;
        top: 0;
        right: 0;
        height: 100%;
        width: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: none;
        border: none;
        opacity: 0;
        transition: opacity 0.2s ease, background-color 0.2s ease;
        color: #6c757d;
        border-radius: 0 8px 8px 0;
    }
    .chat-list form:hover .chat-menu-btn,
    .chat-item.active ~ .chat-menu-btn {
        opacity: 1;
    }
    .chat-menu-btn:hover {
        background-color: rgba(0, 0, 0, 0.05);
        color: #495057;
    }

    /* Кнопка нового чата */
    .btn-new-chat {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        width: 100%;
        font-weight: 500;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }
    .btn-new-chat:hover {
        background-color: #0056b3;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
    }

    /* Выпадающее меню троеточия */
  /* Выпадающее меню троеточия */
    .chat-dropdown {
        position: fixed; /* Важное изменение: fixed вместо absolute */
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        z-index: 10000;
        min-width: 160px;
        width: 160px;
        padding: 6px 0;
        overflow: hidden;
    }
    .dropdown-item {
        padding: 10px 16px;
        font-size: 0.875rem;
        color: #333;
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: background-color 0.15s ease;
        white-space: nowrap;
    }
    .dropdown-item:hover {
        background-color: #f5f5f5;
    }
    .dropdown-item[data-action="delete"]:hover {
        background-color: #ffebee;
        color: #d32f2f;
    }

    /* Иконки в меню (через mask) */
    .dropdown-icon {
        width: 14px;
        height: 14px;
        display: inline-block;
        background-color: currentColor;
        mask-size: contain;
        mask-repeat: no-repeat;
        mask-position: center;
        margin-right: 10px;
        flex-shrink: 0;
    }
    .icon-pencil {
        mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath d='M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106L5.5 12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.293z'/%3E%3C/svg%3E");
    }
    .icon-trash {
        mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath d='M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z'/%3E%3Cpath d='M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3h11V2h-11v1z'/%3E%3C/svg%3E");
    }
    .dropdown-item[data-action="delete"]:hover .dropdown-icon {
        background-color: #d32f2f;
    }

    /* Модальное окно */
    .modal-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 20000;
        backdrop-filter: blur(4px);
    }
    .modal-content {
        background: white;
        border-radius: 16px;
        padding: 24px;
        width: 380px;
        max-width: 90vw;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        text-align: center;
    }
    .modal-content h3 {
        margin: 0 0 12px 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: #111;
    }
    .modal-content p {
        margin: 0 0 24px 0;
        color: #666;
        font-size: 0.95rem;
        line-height: 1.5;
    }
    .modal-rename-input {  /* Лучше добавить отдельный класс для точности */
        display: none;
        width: 100%;
        padding: 12px;
        margin: 20px 0 24px 0;  /* Добавляем margin-top (20px) и margin-bottom (24px) */
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        box-sizing: border-box;
    }
    .modal-rename-input:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
    }
    .modal-actions {
        display: flex;
        justify-content: center;
        gap: 12px;
    }
    .modal-actions button {
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 90px;
    }
    .btn-cancel {
        background: #f1f1f1;
        color: #333;
        border: none;
    }
    .btn-cancel:hover {
        background: #e0e0e0;
    }
    .btn-delete,
    .btn-action {
        background: #d32f2f;
        color: white;
        border: none;
    }
    .btn-delete:hover,
    .btn-action:hover {
        background: #b71c1c;
    }

    /* Flex-структура чата */
    #chat-container {
        height: 100%;
        min-height: 0;
    }
    .chat-main {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    #messages {
        flex: 1 1 auto;
        min-height: 0;
        overflow-y: auto;
    }
    .chat-footer {
        flex-shrink: 0;
    }
</style>

<div class="chat-wrapper d-flex">
    <!-- Левая боковая панель -->
    <div class="sidebar">
        <div>
            <div class="text-center mb-4">
                <div class="logo-circle">#</div>
                <h5 class="mt-3">All Chats</h5>
            </div>

            <!-- Кнопка нового чата -->
            <form action="/conversations/new" method="post">
                <button type="submit" class="btn-new-chat">+ New Chat</button>
            </form>

            <!-- Список чатов -->
            <div class="chat-list-container" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px;">
                <div class="chat-list">
                    {% if conversations %}
                        {% for conv in conversations %}
                        <form action="/conversations/switch-chat"
                              method="POST"
                              hx-post="/conversations/switch-chat"
                              hx-target="#chat-container"
                              hx-swap="innerHTML"
                              onclick='
                                  document.querySelectorAll(".chat-item.active").forEach(el => el.classList.remove("active"));
                                  this.querySelector(".chat-item").classList.add("active");
                                  const chatId = this.querySelector("input[name=\"chat_id\"]").value;
                                  const messageField = document.querySelector("#chat-container input[name=\"chat_id\"]");
                                  if (messageField) messageField.value = chatId;
                              '>

                            <input type="hidden" name="chat_id" value="{{ conv.id }}">

                            <!-- Кнопка переключения чата (всё кроме троеточия) -->
                            <button type="submit"
                                    class="chat-item w-100 {% if conv.id == active_conversation_id %}active{% endif %}"
                                    title="{{ conv.title }}">
                                <div class="d-flex justify-content-between align-items-center w-100">
                                    <div class="chat-title text-truncate">{{ conv.title }}</div>

                                    <!-- Пустое место под троеточие, чтобы название не растягивалось до конца -->
                                    <div class="chat-menu-placeholder"></div>
                                </div>
                            </button>

                            <!-- Отдельная кнопка троеточия (поверх всего, не влияет на submit) -->
                            <button type="button"
                                    class="chat-menu-btn"
                                    data-chat-id="{{ conv.id }}"
                                    title="Меню чата">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/>
                                </svg>
                            </button>
                        </form>

                        <!-- === ВОТ СЮДА ВСТАВЛЯЕМ СКРЫТЫЕ ФОРМЫ === -->
                        <form id="delete-form-{{ conv.id }}" action="/conversations/delete" method="post" style="display: none;">
                            <input type="hidden" name="conversation_id" value="{{ conv.id }}">
                        </form>

                        <form id="rename-form-{{ conv.id }}" action="/conversations/rename_conversation" method="post" style="display: none;">
                            <input type="hidden" name="conversation_id" value="{{ conv.id }}">
                            <input type="hidden" name="new_name" id="rename-input-{{ conv.id }}">
                        </form>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4 text-muted">
                            <small>No chats yet. Start a new conversation!</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Простая статистика -->
        <div class="mt-3 pt-3 border-top">
            <small class="text-muted">
                {% if conversations %}
                    Total: {{ conversations|length }} chat{{ 's' if conversations|length != 1 else '' }}
                {% else %}
                    No chats
                {% endif %}
            </small>
        </div>
    </div>

    <!-- чат -->
    <div id="chat-container" class="flex-grow-1 d-flex flex-column"
         hx-target="this"
         hx-swap="innerHTML">

        {% include "partials/conversations.html" %}
    </div>

    <!-- Модальное окно подтверждения удаления -->
    <!-- Модальное окно (теперь универсальное: для delete и rename) -->
    <div id="action-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="modal-title">Delete chat?</h3>
            <p id="modal-message">Are you sure you want to delete this chat?<br>This action cannot be undone.</p>

            <!-- Поле ввода — видно только при rename -->
            <input type="text" id="modal-rename-input" class="modal-rename-input" placeholder="Новое название чата" >

            <div class="modal-actions">
                <button type="button" class="btn-cancel">Cancel</button>
                <button type="button" class="btn-action">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Глобальные переменные — ОДНИ на весь скрипт
    let currentAction = null;  // 'rename' или 'delete'
    let currentChatId = null;

    // Закрываем все открытые меню при клике вне их
    document.addEventListener('click', function(e) {
        const dropdown = document.querySelector('.chat-dropdown');
        const btn = e.target.closest('.chat-menu-btn');

        if (dropdown && !dropdown.contains(e.target) && !btn) {
            dropdown.remove();
        }
    });

    // Основная функция открытия меню троеточия
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.chat-menu-btn');
        if (!btn) return;

        e.stopPropagation();
        e.preventDefault();

        const chatId = btn.dataset.chatId;
        const form = btn.closest('form');

        // Удаляем старое меню
        const existingMenu = document.querySelector('.chat-dropdown');
        if (existingMenu) {
            existingMenu.remove();
            return;
        }

        // Получаем координаты кнопки
        const rect = btn.getBoundingClientRect();

        // Создаём новое меню
        const menu = document.createElement('div');
        menu.className = 'chat-dropdown';

        // Позиционируем относительно кнопки
        menu.style.top = (rect.bottom + 6) + 'px';
        menu.style.right = (window.innerWidth - rect.right) + 'px';

        menu.innerHTML = `
            <div class="dropdown-item" data-action="rename" data-chat-id="${chatId}">
                <i class="dropdown-icon icon-pencil"></i>
                Rename
            </div>
            <div class="dropdown-item" data-action="delete" data-chat-id="${chatId}">
                <i class="dropdown-icon icon-trash"></i>
                Delete
            </div>
        `;

        // Добавляем в body, а не в форму
        document.body.appendChild(menu);

        // Проверяем, не выходит ли меню за нижний край экрана
        setTimeout(() => {
            const menuRect = menu.getBoundingClientRect();
            if (menuRect.bottom > window.innerHeight) {
                // Если выходит, показываем сверху
                menu.style.top = (rect.top - menuRect.height - 6) + 'px';
            }
        }, 0);

        // Обработка кликов по пунктам меню
        menu.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', function(ev) {
                ev.stopPropagation();

                const action = this.dataset.action;
                const id = this.dataset.chatId;
                const chatForm = document.querySelector(`form input[name="chat_id"][value="${id}"]`)?.closest('form');

                // Сохраняем данные для модалки
                currentAction = action;
                currentChatId = id;

                if (action === 'rename') {
                    document.getElementById('modal-title').textContent = 'Rename chat';
                    document.querySelector('.modal-content').dataset.action = 'rename';
                    document.getElementById('modal-message').textContent = 'Enter a new name for this chat:';
                    const input = document.getElementById('modal-rename-input');
                    input.style.display = 'block';
                    input.value = chatForm ? chatForm.querySelector('.chat-title').textContent.trim() : '';
                    input.focus();
                    input.select();

                    document.querySelector('#action-modal .btn-action').textContent = 'Rename';
                } else if (action === 'delete') {
                    document.getElementById('modal-title').textContent = 'Delete chat?';
                    document.querySelector('.modal-content').dataset.action = 'delete';
                    document.getElementById('modal-message').innerHTML = 'Are you sure you want to delete this chat?<br>This action cannot be undone.';
                    document.getElementById('modal-rename-input').style.display = 'none';

                    document.querySelector('#action-modal .btn-action').textContent = 'Delete';
                }

                document.getElementById('action-modal').style.display = 'flex';
                menu.remove();
            });
        });
    });

    // Обработчики модалки
    document.querySelector('#action-modal .btn-cancel')?.addEventListener('click', () => {
        document.getElementById('action-modal').style.display = 'none';
    });

    document.querySelector('#action-modal .btn-action')?.addEventListener('click', () => {
        if (currentAction === 'delete') {
            const form = document.getElementById(`delete-form-${currentChatId}`);
            if (form) {
                form.submit();
            }
        } else if (currentAction === 'rename') {
            const newTitle = document.getElementById('modal-rename-input').value.trim();
            if (newTitle && newTitle.length > 0) {
                const hiddenInput = document.getElementById(`rename-input-${currentChatId}`);
                if (hiddenInput) {
                    hiddenInput.value = newTitle;
                    const form = document.getElementById(`rename-form-${currentChatId}`);
                    if (form) {
                        form.submit();
                    }
                }
            } else {
                alert('Введите название чата');
                return;
            }
        }

        document.getElementById('action-modal').style.display = 'none';
    });

    // Закрытие по клику на overlay
    document.getElementById('action-modal')?.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
            document.getElementById('action-modal').style.display = 'none';
        }
    });
</script>