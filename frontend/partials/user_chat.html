<style>
    /* Добавьте в ваш CSS файл */
    /* Стилизация скроллбара для боковой панели */
    .sidebar::-webkit-scrollbar {
        width: 6px;
    }

    .sidebar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .sidebar::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }

    .sidebar::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* Стили для чатов в боковой панели */
    /* Форма чата */
    .chat-list form {
        display: block;
        margin-bottom: 5px;
    }

    /* Кнопка в виде чата */
    .chat-item {
        border-radius: 8px;
        padding: 10px 12px;
        border: 1px solid transparent;
        background: transparent;
        text-align: left;
        width: 100%;
        cursor: pointer;
        transition: all 0.05s ease;
        display: block;
    }

    .chat-item:hover {
        background-color: rgba(0, 123, 255, 0.08);
        border-color: rgba(0, 123, 255, 0.2);
    }

    .chat-item.active {
        background-color: rgba(0, 123, 255, 0.1);
        border-left: 3px solid #007bff;
        font-weight: 500;
    }

    /* Убираем стандартные стили кнопки */
    .chat-item:focus {
        outline: none;
        box-shadow: none;
    }

    .chat-time {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 2px;
    }

    /* Стиль для заголовка "All Chats" */
    .chats-header {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }

    /* Кнопка нового чата */
    .btn-new-chat {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        width: 100%;
        font-weight: 500;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }

    .btn-new-chat:hover {
        background-color: #0056b3;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
    }

    /* Контейнер для скролла чатов */
    .chat-list-container {
        max-height: calc(100vh - 280px); /* Адаптивная высота */
        overflow-y: auto;
        padding-right: 5px; /* Отступ для скроллбара */
        margin-bottom: 15px;
        flex: 1; /* Занимает все доступное пространство */
    }

    /* Кастомный скроллбар для контейнера чатов */
    .chat-list-container::-webkit-scrollbar {
        width: 6px;
    }

    .chat-list-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .chat-list-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }

    .chat-list-container::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

        /* Критически важно для стабильной высоты при HTMX-свопе */
    #chat-container {
        height: 100%;
        min-height: 0; /* обязательно для вложенных flex */
    }

    .chat-main {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    #messages {
        flex: 1 1 auto;     /* растягивается */
        min-height: 0;      /* позволяет скроллиться внутри flex */
        overflow-y: auto;
    }

    /* Чтобы футер не влиял на высоту */
    .chat-footer {
        flex-shrink: 0;
    }

    /* Для Firefox */
    .chat-list-container {
        scrollbar-width: thin;
        scrollbar-color: #888 #f1f1f1;
    }

    /* Чтобы sidebar не имел собственного скролла */
    .sidebar {
        overflow-y: hidden;
        display: flex;
        flex-direction: column;
    }

        /* Кнопка троеточия в чате */
    .chat-menu-btn {
        opacity: 0;               /* Скрыта по умолчанию */
        transition: opacity 0.2s ease;
        padding-left: 10px;       /* Отступ от названия */
        flex-shrink: 0;           /* Не сжимается */
        color: #6c757d;           /* Серый цвет, как в типичных UI */
    }

    /* Показываем троеточие при ховере над чатом или когда чат активный */
    .chat-item:hover .chat-menu-btn,
    .chat-item.active .chat-menu-btn {
        opacity: 1;
    }

    /* При ховере над самим троеточием — немного темнее */
    .chat-menu-btn:hover {
        color: #495057;
        cursor: pointer;
    }

    /* Чтобы название чата не растягивалось на всю ширину при длинном тексте */
    .chat-title {
        flex: 1;
        min-width: 0;             /* Важно для text-truncate внутри flex */
    }

        /* Контейнер формы — relative, чтобы позиционировать троеточие абсолютно */
    .chat-list form {
        position: relative;
        display: block;
        margin-bottom: 5px;
    }

    /* Плейсхолдер, чтобы название чата не тянулось под троеточие */
    .chat-menu-placeholder {
        width: 32px;     /* Ширина кнопки троеточия + отступы */
        flex-shrink: 0;
    }

    /* Сама кнопка троеточия — абсолютно позиционирована справа */
    .chat-menu-btn {
        position: absolute;
        top: 0;
        right: 0;
        height: 100%;
        width: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: none;
        border: none;
        opacity: 0;
        transition: opacity 0.2s ease, background-color 0.2s ease;
        color: #6c757d;
        border-radius: 0 8px 8px 0;  /* Скругление только справа, как у чата */
    }

    /* Показываем при ховере над формой или активным чатом */
    .chat-list form:hover .chat-menu-btn,
    .chat-item.active ~ .chat-menu-btn {
        opacity: 1;
    }

    /* Ховер-эффект на троеточии */
    .chat-menu-btn:hover {
        background-color: rgba(0, 0, 0, 0.05);
        color: #495057;
    }
</style>

<div class="chat-wrapper d-flex">
    <!-- Левая боковая панель -->
    <div class="sidebar">
        <div>
            <div class="text-center mb-4">
                <div class="logo-circle">#</div>
                <h5 class="mt-3">All Chats</h5>
            </div>

            <!-- Кнопка нового чата -->
            <form action="/conversations/new" method="post">
                <button type="submit" class="btn-new-chat">+ New Chat</button>
            </form>

            <!-- Список чатов -->
            <div class="chat-list-container" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px;">
                <div class="chat-list">
                    {% if conversations %}
                        {% for conv in conversations %}
                        <form action="/conversations/switch-chat"
                              method="POST"
                              hx-post="/conversations/switch-chat"
                              hx-target="#chat-container"
                              hx-swap="innerHTML"
                              onclick='
                                  document.querySelectorAll(".chat-item.active").forEach(el => el.classList.remove("active"));
                                  this.querySelector(".chat-item").classList.add("active");
                                  const chatId = this.querySelector("input[name=\"chat_id\"]").value;
                                  const messageField = document.querySelector("#chat-container input[name=\"chat_id\"]");
                                  if (messageField) messageField.value = chatId;
                              '>

                            <input type="hidden" name="chat_id" value="{{ conv.id }}">

                            <!-- Кнопка переключения чата (всё кроме троеточия) -->
                            <button type="submit"
                                    class="chat-item w-100 {% if conv.id == active_conversation_id %}active{% endif %}"
                                    title="{{ conv.title }}">
                                <div class="d-flex justify-content-between align-items-center w-100">
                                    <div class="chat-title text-truncate">{{ conv.title }}</div>

                                    <!-- Пустое место под троеточие, чтобы название не растягивалось до конца -->
                                    <div class="chat-menu-placeholder"></div>
                                </div>
                            </button>

                            <!-- Отдельная кнопка троеточия (поверх всего, не влияет на submit) -->
                            <button type="button"
                                    class="chat-menu-btn"
                                    data-chat-id="{{ conv.id }}"
                                    title="Меню чата">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/>
                                </svg>
                            </button>
                        </form>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4 text-muted">
                            <small>No chats yet. Start a new conversation!</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Простая статистика -->
        <div class="mt-3 pt-3 border-top">
            <small class="text-muted">
                {% if conversations %}
                    Total: {{ conversations|length }} chat{{ 's' if conversations|length != 1 else '' }}
                {% else %}
                    No chats
                {% endif %}
            </small>
        </div>
    </div>

    <!-- чат -->
    <div id="chat-container" class="flex-grow-1 d-flex flex-column"
         hx-target="this"
         hx-swap="innerHTML">

        {% include "partials/conversations.html" %}
    </div>
</div>
